{"version":3,"sources":["../../src/commands/build.js"],"names":["report","require","buildHTML","buildProductionBundle","bootstrap","apiRunnerNode","copyStaticDirs","initTracer","stopTracer","db","chalk","tracer","globalTracer","signalExit","telemetry","store","reportFailure","msg","err","log","panic","module","exports","program","openTracingConfigFile","trackCli","buildSpan","startSpan","setTag","directory","parentSpan","graphqlRunner","saveState","graphql","activity","activityTimer","start","catch","end","buildPages","stage","pagePaths","getState","pages","keys","stripIndent","context","path","bold","info","process","uptime","finish","build"],"mappings":"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","sourcesContent":["/* @flow */\n\nconst report = require(`gatsby-cli/lib/reporter`)\nconst buildHTML = require(`./build-html`)\nconst buildProductionBundle = require(`./build-javascript`)\nconst bootstrap = require(`../bootstrap`)\nconst apiRunnerNode = require(`../utils/api-runner-node`)\nconst { copyStaticDirs } = require(`../utils/get-static-dir`)\nconst { initTracer, stopTracer } = require(`../utils/tracer`)\nconst db = require(`../db`)\nconst chalk = require(`chalk`)\nconst tracer = require(`opentracing`).globalTracer()\nconst signalExit = require(`signal-exit`)\nconst telemetry = require(`gatsby-telemetry`)\nconst { store } = require(`../redux`)\n\nfunction reportFailure(msg, err: Error) {\n  report.log(``)\n  report.panic(msg, err)\n}\n\ntype BuildArgs = {\n  directory: string,\n  sitePackageJson: object,\n  prefixPaths: boolean,\n  noUglify: boolean,\n  openTracingConfigFile: string,\n}\n\nmodule.exports = async function build(program: BuildArgs) {\n  initTracer(program.openTracingConfigFile)\n\n  telemetry.trackCli(`BUILD_START`)\n  signalExit(() => {\n    telemetry.trackCli(`BUILD_END`)\n  })\n\n  const buildSpan = tracer.startSpan(`build`)\n  buildSpan.setTag(`directory`, program.directory)\n\n  const { graphqlRunner } = await bootstrap({\n    ...program,\n    parentSpan: buildSpan,\n  })\n\n  await db.saveState()\n\n  await apiRunnerNode(`onPreBuild`, {\n    graphql: graphqlRunner,\n    parentSpan: buildSpan,\n  })\n\n  // Copy files from the static directory to\n  // an equivalent static directory within public.\n  copyStaticDirs()\n\n  let activity\n  activity = report.activityTimer(\n    `Building production JavaScript and CSS bundles`,\n    { parentSpan: buildSpan }\n  )\n  activity.start()\n  await buildProductionBundle(program).catch(err => {\n    reportFailure(`Generating JavaScript bundles failed`, err)\n  })\n  activity.end()\n\n  activity = report.activityTimer(`Building static HTML for pages`, {\n    parentSpan: buildSpan,\n  })\n  activity.start()\n  try {\n    await buildHTML.buildPages({\n      program,\n      stage: `build-html`,\n      pagePaths: [...store.getState().pages.keys()],\n      activity,\n    })\n  } catch (err) {\n    reportFailure(\n      report.stripIndent`\n        Building static HTML failed${\n          err.context && err.context.path\n            ? ` for path \"${chalk.bold(err.context.path)}\"`\n            : ``\n        }\n\n        See our docs page on debugging HTML builds for help https://gatsby.dev/debug-html\n      `,\n      err\n    )\n  }\n  activity.end()\n\n  await apiRunnerNode(`onPostBuild`, {\n    graphql: graphqlRunner,\n    parentSpan: buildSpan,\n  })\n\n  report.info(`Done building in ${process.uptime()} sec`)\n\n  buildSpan.finish()\n  await stopTracer()\n}\n"],"file":"build.js"}