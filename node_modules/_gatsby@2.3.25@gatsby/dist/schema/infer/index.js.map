{"version":3,"sources":["../../../src/schema/infer/index.js"],"names":["report","require","getExampleValue","addNodeInterface","getNodeInterface","addInferredFields","getInferConfig","addInferredType","schemaComposer","typeComposer","nodeStore","typeConflictReporter","typeMapping","parentSpan","typeName","getTypeName","nodes","getNodesByType","hasExtension","getExtension","setExtension","internal","owner","exampleValue","ignoreFields","getFieldNames","inferConfig","addInferredTypes","typeNames","putFileFirst","getTypes","noNodeInterfaceTypes","forEach","has","getOTC","infer","hasInterface","push","getType","createObjectTC","typeComposers","map","length","type","warn","panic","index","indexOf","slice","module","exports"],"mappings":"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","sourcesContent":["const report = require(`gatsby-cli/lib/reporter`)\nconst { getExampleValue } = require(`./example-value`)\nconst {\n  addNodeInterface,\n  getNodeInterface,\n} = require(`../types/node-interface`)\nconst { addInferredFields } = require(`./add-inferred-fields`)\nconst getInferConfig = require(`./get-infer-config`)\n\nconst addInferredType = ({\n  schemaComposer,\n  typeComposer,\n  nodeStore,\n  typeConflictReporter,\n  typeMapping,\n  parentSpan,\n}) => {\n  const typeName = typeComposer.getTypeName()\n  const nodes = nodeStore.getNodesByType(typeName)\n  if (\n    !typeComposer.hasExtension(`plugin`) &&\n    typeComposer.getExtension(`createdFrom`) === `infer`\n  ) {\n    typeComposer.setExtension(`plugin`, nodes[0].internal.owner)\n  }\n  const exampleValue = getExampleValue({\n    nodes,\n    typeName,\n    typeConflictReporter,\n    ignoreFields: [\n      ...getNodeInterface({ schemaComposer }).getFieldNames(),\n      `$loki`,\n    ],\n  })\n\n  addInferredFields({\n    schemaComposer,\n    typeComposer,\n    nodeStore,\n    exampleValue,\n    inferConfig: getInferConfig(typeComposer),\n    typeMapping,\n    parentSpan,\n  })\n  return typeComposer\n}\n\nconst addInferredTypes = ({\n  schemaComposer,\n  nodeStore,\n  typeConflictReporter,\n  typeMapping,\n  parentSpan,\n}) => {\n  // XXX(freiksenet): Won't be needed after plugins set typedefs\n  // Infer File first so all the links to it would work\n  const typeNames = putFileFirst(nodeStore.getTypes())\n  const noNodeInterfaceTypes = []\n\n  typeNames.forEach(typeName => {\n    let typeComposer\n    let inferConfig\n    if (schemaComposer.has(typeName)) {\n      typeComposer = schemaComposer.getOTC(typeName)\n      inferConfig = getInferConfig(typeComposer)\n      if (inferConfig.infer) {\n        if (!typeComposer.hasInterface(`Node`)) {\n          noNodeInterfaceTypes.push(typeComposer.getType())\n        }\n      }\n    } else {\n      typeComposer = schemaComposer.createObjectTC(typeName)\n      typeComposer.setExtension(`createdFrom`, `infer`)\n      addNodeInterface({ schemaComposer, typeComposer })\n    }\n  })\n\n  // XXX(freiksenet): We iterate twice to pre-create all types\n  const typeComposers = typeNames.map(typeName =>\n    addInferredType({\n      schemaComposer,\n      nodeStore,\n      typeConflictReporter,\n      typeComposer: schemaComposer.getOTC(typeName),\n      typeMapping,\n      parentSpan,\n    })\n  )\n\n  if (noNodeInterfaceTypes.length > 0) {\n    noNodeInterfaceTypes.forEach(type => {\n      report.warn(\n        `Type \\`${type}\\` declared in \\`createTypes\\` looks like a node, ` +\n          `but doesn't implement a \\`Node\\` interface. It's likely that you should ` +\n          `add the \\`Node\\` interface to your type def:\\n\\n` +\n          `\\`type ${type} implements Node { ... }\\`\\n\\n` +\n          `If you know that you don't want it to be a node (which would mean no ` +\n          `root queries to retrieve it), you can explicitly disable inference ` +\n          `for it:\\n\\n` +\n          `\\`type ${type} @dontInfer { ... }\\``\n      )\n    })\n    report.panic(`Building schema failed`)\n  }\n\n  return typeComposers\n}\n\nconst putFileFirst = typeNames => {\n  const index = typeNames.indexOf(`File`)\n  if (index !== -1) {\n    return [`File`, ...typeNames.slice(0, index), ...typeNames.slice(index + 1)]\n  } else {\n    return typeNames\n  }\n}\n\nmodule.exports = {\n  addInferredType,\n  addInferredTypes,\n}\n"],"file":"index.js"}