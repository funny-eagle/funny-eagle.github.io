!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t=t||self).XStateGraph={})}(this,function(t){"use strict";var e,r,n=function(){return(n=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)};function i(t,e){var r={};for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.indexOf(n)<0&&(r[n]=t[n]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(t);i<n.length;i++)e.indexOf(n[i])<0&&(r[n[i]]=t[n[i]])}return r}function o(t){var e="function"==typeof Symbol&&t[Symbol.iterator],r=0;return e?e.call(t):{next:function(){return t&&r>=t.length&&(t=void 0),{value:t&&t[r++],done:!t}}}}function a(t,e){var r="function"==typeof Symbol&&t[Symbol.iterator];if(!r)return t;var n,i,o=r.call(t),a=[];try{for(;(void 0===e||e-- >0)&&!(n=o.next()).done;)a.push(n.value)}catch(t){i={error:t}}finally{try{n&&!n.done&&(r=o.return)&&r.call(o)}finally{if(i)throw i.error}}return a}function s(){for(var t=[],e=0;e<arguments.length;e++)t=t.concat(a(arguments[e]));return t}!function(t){t.Start="xstate.start",t.Stop="xstate.stop",t.Raise="xstate.raise",t.Send="xstate.send",t.Cancel="xstate.cancel",t.NullEvent="",t.Assign="xstate.assign",t.After="xstate.after",t.DoneState="done.state",t.DoneInvoke="done.invoke",t.Log="xstate.log",t.Init="xstate.init",t.Invoke="xstate.invoke",t.ErrorExecution="error.execution",t.ErrorCommunication="error.communication"}(e||(e={})),function(t){t.Parent="#_parent",t.Internal="#_internal"}(r||(r={}));var c=".",u={};var h=function(){function t(t){this.actions=[],this.activities=u,this.meta={},this.events=[],this.value=t.value,this.context=t.context,this.event=t.event,this.historyValue=t.historyValue,this.history=t.history,this.actions=t.actions||[],this.activities=t.activities||u,this.meta=t.meta||{},this.events=t.events||[],Object.defineProperty(this,"tree",{value:t.tree,enumerable:!1})}return t.from=function(r,n){return r instanceof t?r.context!==n?new t({value:r.value,context:n,event:r.event,historyValue:r.historyValue,history:r.history,actions:[],activities:r.activities,meta:{},events:[],tree:r.tree}):r:new t({value:r,context:n,event:{type:e.Init},historyValue:void 0,history:void 0,actions:[],activities:void 0,meta:void 0,events:[]})},t.create=function(e){return new t(e)},t.inert=function(r,n){if(r instanceof t){if(!r.actions.length)return r;var i={type:e.Init};return new t({value:r.value,context:n,event:i,historyValue:r.historyValue,history:r.history,activities:r.activities,tree:r.tree})}return t.from(r,n)},Object.defineProperty(t.prototype,"inert",{get:function(){return t.inert(this,this.context)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"nextEvents",{get:function(){return this.tree?this.tree.nextEvents:[]},enumerable:!0,configurable:!0}),t.prototype.toStrings=function(t,e){var r=this;if(void 0===t&&(t=this.value),void 0===e&&(e="."),ht(t))return[t];var n=U(t);return n.concat.apply(n,s(n.map(function(n){return r.toStrings(t[n]).map(function(t){return n+e+t})})))},t.prototype.matches=function(t){return q(t,this.value)},t}(),l=e.Start,f=e.Stop,d=e.Raise,v=e.Send,p=e.Cancel,y=e.NullEvent,m=e.Assign,g=(e.After,e.DoneState,e.Log),x=e.Init,w=e.Invoke,S=e.ErrorExecution,b={type:x};function E(t,e){if(ht(t)||"number"==typeof t){var r={type:t};return e&&Object.assign(r,e),r}return t}function N(t,e){if(e){var r=e[t];if(r)return ut(r),r}}function O(t,e){var r;if(ht(t)||"number"==typeof t){var o=N(t,e);r=ut(o)?{type:t,exec:o}:o||{type:t,exec:void 0}}else if(ut(t))r={type:t.name||t.toString(),exec:t};else{if(ut(o=N(t.type,e)))r=n({},t,{exec:o});else if(o){var a=t.type,s=i(t,["type"]);r=n({type:a},o,s)}else r=t}return Object.defineProperty(r,"toString",{value:function(){return r.type},enumerable:!1,configurable:!0}),r}function k(t){var e=O(t);return n({id:ht(t)?t:e.id},e,{type:e.type})}function P(t){return{type:d,event:t}}function j(t,e){return{to:e?e.to:void 0,type:v,event:ut(t)?t:E(t),delay:e?e.delay:void 0,id:e&&void 0!==e.id?e.id:ut(t)?t.name:B(t)}}var T=function(t){return{type:p,sendId:t}};function V(t){var r=k(t);return{type:e.Start,activity:r,exec:void 0}}function _(t,r){var n=r?"#"+r:"";return e.After+"("+t+")"+n}function I(t,r){var n=e.DoneState+"."+t,i={type:n,data:r,toString:function(){return n}};return i}function z(t,r){var n=e.DoneInvoke+"."+t,i={type:n,data:r,toString:function(){return n}};return i}function L(t,r){return{src:r,type:e.ErrorExecution,data:t}}var D={resolved:!1},A=function(){function t(e,r,i){var o;void 0===i&&(i=D),this.stateNode=e,this.stateValue=r,this.nodes=r?ht(r)?((o={})[r]=new t(e.getStateNode(r),void 0),o):W(r,function(r,n){return new t(e.getStateNode(n),r)}):{};var a=n({},D,i);this.isResolved=a.resolved}return Object.defineProperty(t.prototype,"done",{get:function(){var t=this;switch(this.stateNode.type){case"final":return!0;case"compound":return"final"===this.nodes[U(this.nodes)[0]].stateNode.type;case"parallel":return U(this.nodes).every(function(e){return t.nodes[e].done});default:return!1}},enumerable:!0,configurable:!0}),t.prototype.getDoneData=function(t,e){if(this.done&&"compound"===this.stateNode.type){var r=this.nodes[U(this.nodes)[0]];if(!r.stateNode.data)return;return rt(r.stateNode.data,t,e)}},Object.defineProperty(t.prototype,"atomicNodes",{get:function(){var t=this;return"atomic"===this.stateNode.type||"final"===this.stateNode.type?[this.stateNode]:tt(U(this.value).map(function(e){return t.value[e].atomicNodes}))},enumerable:!0,configurable:!0}),t.prototype.getDoneEvents=function(t){var e=this;if(!t||!t.size)return[];if(t.has(this.stateNode)&&"final"===this.stateNode.type)return[I(this.stateNode.id,this.stateNode.data)];var r=tt(U(this.nodes).map(function(r){return e.nodes[r].getDoneEvents(t)}));if("parallel"===this.stateNode.type){var n=U(this.nodes).every(function(t){return e.nodes[t].done});return r&&n?r.concat(I(this.stateNode.id)):r}if(!this.done||!r.length)return r;var i=1===r.length?r[0].data:void 0;return r.concat(I(this.stateNode.id,i))},Object.defineProperty(t.prototype,"resolved",{get:function(){return new t(this.stateNode,this.stateNode.resolve(this.value),{resolved:!0})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"paths",{get:function(){return $(this.value)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"absolute",{get:function(){for(var e=this.stateValue,r={},n=r,i=0;i<this.stateNode.path.length;i++){var o=this.stateNode.path[i];i===this.stateNode.path.length-1?n[o]=e:(n[o]={},n=n[o])}return new t(this.stateNode.machine,r)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"nextEvents",{get:function(){var t=this,e=this.stateNode.ownEvents,r=tt(U(this.nodes).map(function(e){return t.nodes[e].nextEvents}));return s(new Set(r.concat(e)))},enumerable:!0,configurable:!0}),t.prototype.clone=function(){return new t(this.stateNode,this.value)},t.prototype.combine=function(t){var e,r,n;if(t.stateNode!==this.stateNode)throw new Error("Cannot combine distinct trees");if("compound"===this.stateNode.type){var i=void 0;if(U(this.nodes).length&&U(t.nodes).length){var a=U(this.nodes)[0];return(e={})[a]=this.nodes[a].combine(t.nodes[a]),i=e,(c=this.clone()).nodes=i,c}return i=Object.assign({},this.nodes,t.nodes),(c=this.clone()).nodes=i,c}if("parallel"===this.stateNode.type){var c,u=new Set(s(U(this.nodes),U(t.nodes)));i={};try{for(var h=o(u),l=h.next();!l.done;l=h.next()){var f=l.value;this.nodes[f]&&t.nodes[f]?i[f]=this.nodes[f].combine(t.nodes[f]):i[f]=this.nodes[f]||t.nodes[f]}}catch(t){r={error:t}}finally{try{l&&!l.done&&(n=h.return)&&n.call(h)}finally{if(r)throw r.error}}return(c=this.clone()).nodes=i,c}return this},Object.defineProperty(t.prototype,"value",{get:function(){if("atomic"===this.stateNode.type||"final"===this.stateNode.type)return{};if("parallel"===this.stateNode.type)return W(this.nodes,function(t){return t.value});if("compound"===this.stateNode.type){if(0===U(this.nodes).length)return{};var t=this.nodes[U(this.nodes)[0]].stateNode;return"atomic"===t.type||"final"===t.type?t.key:W(this.nodes,function(t){return t.value})}return{}},enumerable:!0,configurable:!0}),t.prototype.matches=function(t){return q(t,this.value)},t.prototype.getEntryExitStates=function(t,e){var r,n,i=this;if(t.stateNode!==this.stateNode)throw new Error("Cannot compare distinct trees");switch(this.stateNode.type){case"compound":var a={exit:[],entry:[]},c=U(this.nodes)[0],u=U(t.nodes)[0];return c!==u?(a.exit=t.nodes[u].getExitStates(),a.entry=this.nodes[c].getEntryStates()):a=this.nodes[c].getEntryExitStates(t.nodes[u],e),e&&e.has(this.stateNode)&&(a.exit.push(this.stateNode),a.entry.unshift(this.stateNode)),a;case"parallel":var h=U(this.nodes).map(function(r){return i.nodes[r].getEntryExitStates(t.nodes[r],e)}),l={exit:[],entry:[]};try{for(var f=o(h),d=f.next();!d.done;d=f.next()){var v=d.value;l.exit=s(l.exit,v.exit),l.entry=s(l.entry,v.entry)}}catch(t){r={error:t}}finally{try{d&&!d.done&&(n=f.return)&&n.call(f)}finally{if(r)throw r.error}}return e&&e.has(this.stateNode)&&(l.exit.push(this.stateNode),l.entry.unshift(this.stateNode)),l;case"atomic":default:return e&&e.has(this.stateNode)?{exit:[this.stateNode],entry:[this.stateNode]}:{exit:[],entry:[]}}},t.prototype.getEntryStates=function(){var t=this;return this.nodes?[this.stateNode].concat(tt(U(this.nodes).map(function(e){return t.nodes[e].getEntryStates()}))):[this.stateNode]},t.prototype.getExitStates=function(){var t=this;return this.nodes?tt(U(this.nodes).map(function(e){return t.nodes[e].getExitStates()})).concat(this.stateNode):[this.stateNode]},t}(),C=".",M="",R={},J=function(t){return"#"===t[0]},F=function(){return{actions:{},guards:{},services:{},activities:{},delays:{},updater:at}};!function(){function t(e,r,i){var o=this;this._config=e,this.context=i,this.__cache={events:void 0,relativeValue:new Map,initialState:void 0},this.idMap={},this.options=n({},F(),r),this.key=e.key||e.id||"(machine)",this.parent=e.parent,this.machine=this.parent?this.parent.machine:this,this.path=this.parent?this.parent.path.concat(this.key):[],this.delimiter=e.delimiter||(this.parent?this.parent.delimiter:C),this.id=e.id||(this.machine?s([this.machine.key],this.path).join(this.delimiter):this.key),this.version=this.parent?this.parent.version:e.version,this.type=e.type||(e.parallel?"parallel":e.states&&U(e.states).length?"compound":e.history?"history":"atomic"),st(!("parallel"in e),'The "parallel" property is deprecated and will be removed in version 4.1. '+(e.parallel?"Replace with `type: 'parallel'`":"Use `type: '"+this.type+"'`")+" in the config for state node '"+this.id+"' instead."),this.initial=e.initial,this.order=e.order||-1,this.states=e.states?W(e.states,function(e,r,i,a){var s,c=new t(n({},e,{key:r,order:void 0===e.order?a:e.order,parent:o}));return Object.assign(o.idMap,n(((s={})[c.id]=c,s),c.idMap)),c}):R,this.history=!0===e.history?"shallow":e.history||!1,this.transient=!(!e.on||!e.on[M]),this.strict=!!e.strict,this.onEntry=et(e.entry||e.onEntry).map(function(t){return O(t)}),this.onExit=et(e.exit||e.onExit).map(function(t){return O(t)}),this.meta=e.meta,this.data="final"===this.type?e.data:void 0,this.invoke=et(e.invoke).map(function(e,r){var i,a;if(e instanceof t)return(o.parent||o).options.services=n(((i={})[e.id]=e,i),(o.parent||o).options.services),{type:w,src:e.id,id:e.id};if("string"!=typeof e.src){var s=o.id+":invocation["+r+"]";return o.machine.options.services=n(((a={})[s]=e.src,a),o.machine.options.services),n({type:w,id:s},e,{src:s})}return n({},e,{type:w,id:e.id||e.src,src:e.src})}),this.activities=et(e.activities).concat(this.invoke).map(function(t){return k(t)}),this.after=this.getDelayedTransitions()}t.prototype.withConfig=function(e,r){void 0===r&&(r=this.context);var i=this.options,o=i.actions,a=i.activities,s=i.guards,c=i.services,u=i.delays;return new t(this.definition,{actions:n({},o,e.actions),activities:n({},a,e.activities),guards:n({},s,e.guards),services:n({},c,e.services),delays:n({},u,e.delays)},r)},t.prototype.withContext=function(e){return new t(this.definition,this.options,e)},Object.defineProperty(t.prototype,"definition",{get:function(){return{id:this.id,key:this.key,version:this.version,type:this.type,initial:this.initial,history:this.history,states:W(this.states,function(t){return t.definition}),on:this.on,onEntry:this.onEntry,onExit:this.onExit,activities:this.activities||[],meta:this.meta,order:this.order||-1,data:this.data}},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"config",{get:function(){var t=this._config;t.parent;return i(t,["parent"])},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"on",{get:function(){return this.formatTransitions()},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"transitions",{get:function(){var t=this;return tt(U(this.on).map(function(e){return t.on[e]}))},enumerable:!0,configurable:!0}),t.prototype.getDelayedTransitions=function(){var t=this;if(this.after)return this.after;var e=this.config.after;if(!e)return[];if(ct(e))return e.map(function(e,r){var i,o=e.delay;ut(o)?(i=t.id+":delay["+r+"]",t.options.delays[i]=o):i=o;var a=_(i,t.id);return t.onEntry.push(j(a,{delay:o})),t.onExit.push(T(a)),n({event:a},e,{cond:e.cond?t.toGuard(e.cond):void 0,actions:et(e.actions).map(function(t){return O(t)})})});var r=tt(U(e).map(function(r){var i=e[r],o=isNaN(+r)?r:+r,a=_(o,t.id);return t.onEntry.push(j(a,{delay:o})),t.onExit.push(T(a)),ht(i)?[{target:i,delay:o,event:a,actions:[]}]:et(i).map(function(e){return n({event:a,delay:o},e,{cond:e.cond?t.toGuard(e.cond):void 0,actions:et(e.actions).map(function(t){return O(t)})})})}));return r.sort(function(t,e){return ht(t)||ht(e)?0:+t.delay-+e.delay}),r},t.prototype.getStateNodes=function(t){var e,r=this;if(!t)return[];var n=t instanceof h?t.value:K(t,this.delimiter);if(ht(n)){var i=this.getStateNode(n).initial;return void 0!==i?this.getStateNodes(((e={})[n]=i,e)):[this.states[n]]}var o=U(n);return o.map(function(t){return r.getStateNode(t)}).concat(o.reduce(function(t,e){var i=r.getStateNode(e).getStateNodes(n[e]);return t.concat(i)},[]))},t.prototype.handles=function(t){var e=B(t);return-1!==this.events.indexOf(e)},t.prototype.resolveState=function(t){var e=this.getStateTree(t.value),r=this.resolve(t.value);return new h({value:r,context:t.context,event:t.event,historyValue:t.historyValue,history:t.history,actions:t.actions,activities:t.activities,meta:t.meta,events:t.events,tree:e})},t.prototype.transitionLeafNode=function(t,e,r){var n=this.getStateNode(t).next(e,r);if(!n.tree){var i=this.next(e,r),o=i.reentryStates,a=i.actions;return{tree:i.tree,source:e,reentryStates:o,actions:a}}return n},t.prototype.transitionCompoundNode=function(t,e,r){var n=U(t),i=this.getStateNode(n[0])._transition(t[n[0]],e,r);if(!i.tree){var o=this.next(e,r),a=o.reentryStates,s=o.actions;return{tree:o.tree,source:e,reentryStates:a,actions:s}}return i},t.prototype.transitionParallelNode=function(t,e,r){var n,i,a=this,c={};try{for(var u=o(U(t)),h=u.next();!h.done;h=u.next()){var l=h.value,f=t[l];if(f){var d=this.getStateNode(l)._transition(f,e,r);d.tree,c[l]=d}}}catch(t){n={error:t}}finally{try{h&&!h.done&&(i=u.return)&&i.call(u)}finally{if(n)throw n.error}}if(!U(c).some(function(t){return void 0!==c[t].tree})){var v=this.next(e,r),p=v.reentryStates,y=v.actions;return{tree:v.tree,source:e,reentryStates:p,actions:y}}var m=U(c).map(function(t){return c[t].tree}).filter(function(t){return void 0!==t}).reduce(function(t,e){return t.combine(e)});return 1!==m.paths.length||q(K(this.path,this.delimiter),m.value)?{tree:U(c).map(function(t){var r=c[t],n=Z(a.path)(r.tree?r.tree.value:e.value||e.value)[t];return new A(a.getStateNode(t),n).absolute}).reduce(function(t,e){return t.combine(e)}),source:e,reentryStates:U(c).reduce(function(t,e){var r=c[e],n=r.tree,i=r.reentryStates;return n&&i?new Set(s(Array.from(t),Array.from(i))):t},new Set),actions:tt(U(c).map(function(t){return c[t].actions}))}:{tree:m,source:e,reentryStates:U(c).map(function(t){return c[t].reentryStates}).reduce(function(t,e){var r,n;if(!e)return t;try{for(var i=o(e),a=i.next();!a.done;a=i.next()){var s=a.value;t.add(s)}}catch(t){r={error:t}}finally{try{a&&!a.done&&(n=i.return)&&n.call(i)}finally{if(r)throw r.error}}return t},new Set),actions:tt(U(c).map(function(t){return c[t].actions}))}},t.prototype._transition=function(t,e,r){return ht(t)?this.transitionLeafNode(t,e,r):1===U(t).length?this.transitionCompoundNode(t,e,r):this.transitionParallelNode(t,e,r)},t.prototype.next=function(t,e){var r,n,i=this,a=e.type,c=this.on[a],u=this.transient?[{type:y}]:[];if(!c||!c.length)return{tree:void 0,source:t,reentryStates:void 0,actions:u};var h,l=[];try{for(var f=o(c),d=f.next();!d.done;d=f.next()){var v=d.value,p=v.cond,m=v.in,g=t.context,x=!m||(ht(m)&&J(m)?t.matches(K(this.getStateNodeById(m).path,this.delimiter)):q(K(m,this.delimiter),Z(this.path.slice(0,-2))(t.value)));if((!p||this.evaluateGuard(p,g,e,t))&&x){l=et(v.target),u.push.apply(u,s(et(v.actions))),h=v;break}}}catch(t){r={error:t}}finally{try{d&&!d.done&&(n=f.return)&&n.call(f)}finally{if(r)throw r.error}}if(h&&0===l.length)return{tree:t.value?this.machine.getStateTree(t.value):void 0,source:t,reentryStates:void 0,actions:u};if(!h&&0===l.length)return{tree:void 0,source:t,reentryStates:void 0,actions:u};var w=tt(l.map(function(e){return i.getRelativeStateNodes(e,t.historyValue)})),S=!!h.internal?[]:tt(w.map(function(t){return i.nodesFromChild(t)}));return{tree:w.map(function(t){return t.tree}).reduce(function(t,e){return t.combine(e)}),source:t,reentryStates:new Set(S),actions:u}},Object.defineProperty(t.prototype,"tree",{get:function(){var t=K(this.path,this.delimiter);return new A(this.machine,t)},enumerable:!0,configurable:!0}),t.prototype.nodesFromChild=function(t){if(t.escapes(this))return[];for(var e=[],r=t;r&&r!==this;)e.push(r),r=r.parent;return e.push(this),e},t.prototype.getStateTree=function(t){return new A(this,t)},t.prototype.escapes=function(t){if(this===t)return!1;for(var e=this.parent;e;){if(e===t)return!1;e=e.parent}return!0},t.prototype.evaluateGuard=function(t,e,r,n){var i=this.machine.options.guards,o={state:n,cond:t};if("xstate.cond"===t.type)return t.predicate(e,r,o);if(!i[t.type])throw new Error("Guard (condition) '"+t.type+"' is not implemented on machine '"+this.machine.id+"'.");return(0,i[t.type])(e,r,o)},t.prototype.toGuard=function(t){return ht(t)?{type:t}:ut(t)?{type:"xstate.cond",predicate:t}:t},t.prototype.getActions=function(t,r){var n=this,i=t.tree?t.tree.resolved.getEntryExitStates(this.getStateTree(r.value),t.reentryStates?t.reentryStates:void 0):{entry:[],exit:[]},o=t.tree?t.tree.getDoneEvents(new Set(i.entry)):[];t.source||(i.exit=[],i.entry.unshift(this));var c=new Set(i.entry),u=new Set(i.exit),h=a([tt(Array.from(c).map(function(t){return s(t.activities.map(function(t){return V(t)}),t.onEntry)})).concat(o.map(P)),tt(Array.from(u).map(function(t){return s(t.onExit,t.activities.map(function(t){return function(t){var r=k(t);return{type:e.Stop,activity:r,exec:void 0}}(t)}))}))],2),l=h[0];return h[1].concat(t.actions).concat(l).map(function(t){return O(t,n.machine.options.actions)})},t.prototype.transition=function(t,r,i){var o;if(t instanceof h)o=void 0===i?t:this.resolveState(h.from(t,i));else{var a=ht(t)?this.resolve(Q(this.getResolvedPath(t))):this.resolve(t),s=i||this.machine.context;o=this.resolveState(h.from(a,s))}var c=E(r),u=c.type;if(this.strict&&-1===this.events.indexOf(u)&&!function(t){if(0===t.indexOf(e.DoneState)||0===t.indexOf(e.DoneInvoke))return!0;if(t===e.ErrorCommunication||t===e.ErrorCommunication)return!0;return!1}(u))throw new Error("Machine '"+this.id+"' does not accept event '"+u+"'");var l=this._transition(o.value,o,c),f=n({},l,{tree:l.tree?l.tree.resolved:void 0});return this.resolveTransition(f,o,c)},t.prototype.resolveTransition=function(t,r,i){var c,u,p,g=this,x=t.tree?t.tree.value:void 0,w=r.historyValue?r.historyValue:t.source?this.machine.historyValue(r.value):void 0,S=this.getActions(t,r),N=n({},r.activities);try{for(var k=o(S),P=k.next();!P.done;P=k.next()){var j=P.value;j.type===l?N[j.activity.type]=j:j.type===f&&(N[j.activity.type]=!1)}}catch(t){c={error:t}}finally{try{P&&!P.done&&(u=k.return)&&u.call(k)}finally{if(c)throw c.error}}var T=a(it(S,function(t){return t.type===d||t.type===y}),2),V=T[0],_=a(it(T[1],function(t){return t.type===m}),2),I=_[0],z=_[1],L=I.length?this.options.updater(r.context,i,I):r.context,D=z.map(function(t){var r=O(t);if(r.type===v){var o=function(t,e,r){var i=ut(t.event)?E(t.event(e,r)):E(t.event),o=ut(t.delay)?t.delay(e,r):t.delay;return n({},t,{event:i,delay:o})}(r,L,i||{type:e.Init});if(ht(o.delay)){if(!g.machine.options.delays||void 0===g.machine.options.delays[o.delay])return st(!1,"No delay reference for delay expression '"+o.delay+"' was found on machine '"+g.machine.id+"'"),o;var a=g.machine.options.delays[o.delay];o.delay="number"==typeof a?a:a(L,i||{type:e.Init})}return o}return O(r,g.options.actions)}),A=x?this.getStateNodes(x):[];A.some(function(t){return t.transient})&&V.push({type:y});var C,R,J=s([this],A).reduce(function(t,e){return void 0!==e.meta&&(t[e.id]=e.meta),t},{}),F=x?new h({value:x,context:L,event:i||b,historyValue:w?(C=w,R=x,{current:R,states:ot(C,R)}):void 0,history:t.source?r:void 0,actions:D,activities:N,meta:J,events:V,tree:t.tree}):void 0;if(!F)return(F=new h({value:r.value,context:L,event:i,historyValue:r.historyValue,history:r,actions:[],activities:r.activities,meta:r.meta,events:[],tree:r.tree})).changed=!!I.length,F;var G=F.history;G&&delete G.history;for(var q=F;V.length;){var B=q.actions,X=V.shift();(q=this.transition(q,X.type===y?M:X.event,q.context)).event=i,(p=q.actions).unshift.apply(p,s(B))}var H=G?!!q.actions.length||!!I.length||typeof G.value!=typeof q.value||!function t(e,r){if(e===r)return!0;if(void 0===e||void 0===r)return!1;if(ht("string"===e||typeof r))return e===r;var n=U(e),i=U(r);return n.length===i.length&&n.every(function(n){return t(e[n],r[n])})}(q.value,G.value):void 0;return q.changed=H,q.historyValue=F.historyValue,q.history=G,q},t.prototype.ensureValidPaths=function(t){var e,r,n=this,i=new Map,a=tt(t.map(function(t){return n.getRelativeStateNodes(t)}));try{t:for(var s=o(a),c=s.next();!c.done;c=s.next())for(var u=c.value,h=u;h.parent;){if(i.has(h.parent)){if("parallel"===h.parent.type)continue t;throw new Error("State node '"+u.id+"' shares parent '"+h.parent.id+"' with state node '"+i.get(h.parent).map(function(t){return t.id})+"'")}i.get(h.parent)?i.get(h.parent).push(u):i.set(h.parent,[u]),h=h.parent}}catch(t){e={error:t}}finally{try{c&&!c.done&&(r=s.return)&&r.call(s)}finally{if(e)throw e.error}}},t.prototype.getStateNode=function(t){if(J(t))return this.machine.getStateNodeById(t);if(!this.states)throw new Error("Unable to retrieve child state '"+t+"' from '"+this.id+"'; no child states exist.");var e=this.states[t];if(!e)throw new Error("Child state '"+t+"' does not exist on '"+this.id+"'");return e},t.prototype.getStateNodeById=function(t){var e=J(t)?t.slice("#".length):t;if(e===this.id)return this;var r=this.machine.idMap[e];if(!r)throw new Error("Substate '#"+e+"' does not exist on '"+this.id+"'");return r},t.prototype.getStateNodeByPath=function(t){for(var e=H(t,this.delimiter).slice(),r=this;e.length;){var n=e.shift();r=r.getStateNode(n)}return r},t.prototype.resolve=function(t){var e,r=this;if(!t)return this.initialStateValue||R;switch(this.type){case"parallel":return W(this.initialStateValue,function(e,n){return e?r.getStateNode(n).resolve(t[n]||e):R});case"compound":if(ht(t)){var n=this.getStateNode(t);return"parallel"===n.type||"compound"===n.type?((e={})[t]=n.initialStateValue,e):t}return U(t).length?W(t,function(t,e){return t?r.getStateNode(e).resolve(t):R}):this.initialStateValue||{};default:return t||R}},Object.defineProperty(t.prototype,"resolvedStateValue",{get:function(){var t,e,r=this.key;if("parallel"===this.type)return(t={})[r]=Y(this.states,function(t){return t.resolvedStateValue[t.key]},function(t){return!("history"===t.type)}),t;if(void 0===this.initial)return r;if(!this.states[this.initial])throw new Error("Initial state '"+this.initial+"' not found on '"+r+"'");return(e={})[r]=this.states[this.initial].resolvedStateValue,e},enumerable:!0,configurable:!0}),t.prototype.getResolvedPath=function(t){if(J(t)){var e=this.machine.idMap[t.slice("#".length)];if(!e)throw new Error("Unable to find state node '"+t+"'");return e.path}return H(t,this.delimiter)},Object.defineProperty(t.prototype,"initialStateValue",{get:function(){if(this.__cache.initialState)return this.__cache.initialState;var t="parallel"===this.type?Y(this.states,function(t){return t.initialStateValue||R},function(t){return!("history"===t.type)}):ht(this.resolvedStateValue)?void 0:this.resolvedStateValue[this.key];return this.__cache.initialState=t,this.__cache.initialState},enumerable:!0,configurable:!0}),t.prototype.getInitialState=function(t,r){var n,i,a,c;void 0===r&&(r=this.machine.context);var u={},l=[];try{for(var f=o(this.getStateNodes(t)),d=f.next();!d.done;d=f.next()){var v=d.value;if(v.onEntry&&l.push.apply(l,s(v.onEntry)),v.activities)try{for(var p=o(v.activities),y=p.next();!y.done;y=p.next()){var g=y.value;u[B(g)]=g,l.push(V(g))}}catch(t){a={error:t}}finally{try{y&&!y.done&&(c=p.return)&&c.call(p)}finally{if(a)throw a.error}}}}catch(t){n={error:t}}finally{try{d&&!d.done&&(i=f.return)&&i.call(f)}finally{if(n)throw n.error}}var x=l.filter(function(t){return"object"==typeof t&&t.type===m}),w=this.options.updater(r,{type:e.Init},x);return new h({value:t,context:w,event:b,activities:u})},Object.defineProperty(t.prototype,"initialState",{get:function(){var t=this.initialStateValue;if(!t)throw new Error("Cannot retrieve initial state from simple state '"+this.id+"'.");var r=this.getInitialState(t);return this.resolveTransition({tree:this.getStateTree(t),source:void 0,reentryStates:new Set(this.getStateNodes(t)),actions:[]},r,{type:e.Init})},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"target",{get:function(){var t;if("history"===this.type){var e=this.config;t=e.target&&ht(e.target)&&J(e.target)?Q(this.machine.getStateNodeById(e.target).path.slice(this.path.length-1)):e.target}return t},enumerable:!0,configurable:!0}),t.prototype.getStates=function(t){var e,r;if(ht(t))return[this.states[t]];var n=[];try{for(var i=o(U(t)),a=i.next();!a.done;a=i.next()){var c=a.value;n.push.apply(n,s(this.states[c].getStates(t[c])))}}catch(t){e={error:t}}finally{try{a&&!a.done&&(r=i.return)&&r.call(i)}finally{if(e)throw e.error}}return n},t.prototype.getRelativeStateNodes=function(t,e,r){if(void 0===r&&(r=!0),ht(t)&&J(t)){var n=this.getStateNodeById(t);return r?"history"===n.type?n.resolveHistory(e):n.initialStateNodes:[n]}var i=H(t,this.delimiter),o=(this.parent||this).getFromRelativePath(i,e);return r?tt(o.map(function(t){return t.initialStateNodes})):o},Object.defineProperty(t.prototype,"initialStateNodes",{get:function(){var t=this;return"atomic"===this.type||"final"===this.type?[this]:"compound"!==this.type||this.initial?tt($(this.initialStateValue).map(function(e){return t.getFromRelativePath(e)})):(st(!1,"Compound state node '"+this.id+"' has no initial state."),[this])},enumerable:!0,configurable:!0}),t.prototype.getFromRelativePath=function(t,e){if(!t.length)return[this];var r=a(t),n=r[0],i=r.slice(1);if(!this.states)throw new Error("Cannot retrieve subPath '"+n+"' from node with no states");var o=this.getStateNode(n);if("history"===o.type)return o.resolveHistory(e);if(!this.states[n])throw new Error("Child state '"+n+"' does not exist on '"+this.id+"'");return this.states[n].getFromRelativePath(i,e)},t.prototype.historyValue=function(t){if(U(this.states).length)return{current:t||this.initialStateValue,states:Y(this.states,function(e,r){if(!t)return e.historyValue();var n=ht(t)?void 0:t[r];return e.historyValue(n||e.initialStateValue)},function(t){return!t.history})}},t.prototype.resolveHistory=function(t){var e=this;if("history"!==this.type)return[this];var r=this.parent;if(!t)return this.target?tt($(this.target).map(function(t){return r.getFromRelativePath(t)})):r.initialStateNodes;var n,i,a=(n=r.path,i="states",function(t){var e,r,a=t;try{for(var s=o(n),c=s.next();!c.done;c=s.next()){var u=c.value;a=a[i][u]}}catch(t){e={error:t}}finally{try{c&&!c.done&&(r=s.return)&&r.call(s)}finally{if(e)throw e.error}}return a})(t).current;return ht(a)?[r.getStateNode(a)]:tt($(a).map(function(t){return"deep"===e.history?r.getFromRelativePath(t):[r.states[t[0]]]}))},Object.defineProperty(t.prototype,"stateIds",{get:function(){var t=this,e=tt(U(this.states).map(function(e){return t.states[e].stateIds}));return[this.id].concat(e)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"events",{get:function(){var t,e,r,n;if(this.__cache.events)return this.__cache.events;var i=this.states,a=new Set(this.ownEvents);if(i)try{for(var s=o(U(i)),c=s.next();!c.done;c=s.next()){var u=i[c.value];if(u.states)try{for(var h=o(u.events),l=h.next();!l.done;l=h.next()){var f=l.value;a.add(""+f)}}catch(t){r={error:t}}finally{try{l&&!l.done&&(n=h.return)&&n.call(h)}finally{if(r)throw r.error}}}}catch(e){t={error:e}}finally{try{c&&!c.done&&(e=s.return)&&e.call(s)}finally{if(t)throw t.error}}return this.__cache.events=Array.from(a)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"ownEvents",{get:function(){var t=this,e=new Set(U(this.on).filter(function(e){return t.on[e].some(function(t){return!(!t.target&&!t.actions.length&&t.internal)})}));return Array.from(e)},enumerable:!0,configurable:!0}),t.prototype.formatTransition=function(e,r,i){var o=this,a=r?r.internal:void 0;if(void 0===e||""===e)return n({},r,{actions:r?et(r.actions).map(function(t){return O(t)}):[],cond:r&&r.cond?this.toGuard(r.cond):void 0,target:void 0,internal:void 0===a||a,event:i});var s=et(e).map(function(e){if(e instanceof t)return"#"+e.id;var r=ht(e)&&e[0]===o.delimiter;return a=void 0===a?r:a,r&&!o.parent?e.slice(1):r?o.key+e:""+e});return n({},r,{actions:r?et(r.actions).map(function(t){return O(t)}):[],cond:r&&r.cond?this.toGuard(r.cond):void 0,target:s,internal:a,event:i})},t.prototype.formatTransitions=function(){var e,r,i,a=this,s=this.config.on||R,c=this.config.onDone?((e={})[""+I(this.id)]=this.config.onDone,e):void 0,u=this.invoke.reduce(function(t,e){return e.onDone&&(t[z(e.id)]=e.onDone),e.onError&&(t[S]=e.onError),t},{}),h=this.after,l=W(n({},s,c,u),function(e,r){return void 0===e?[{target:void 0,event:r,actions:[],internal:!0}]:ct(e)?e.map(function(t){return a.formatTransition(t.target,t,r)}):ht(e)||e instanceof t?[a.formatTransition([e],void 0,r)]:[a.formatTransition(e.target,e,r)]});try{for(var f=o(h),d=f.next();!d.done;d=f.next()){var v=d.value;l[v.event]=l[v.event]||[],l[v.event].push(v)}}catch(t){r={error:t}}finally{try{d&&!d.done&&(i=f.return)&&i.call(f)}finally{if(r)throw r.error}}return l}}();function G(t){return!ht(t)&&("value"in t&&"tree"in t&&"history"in t)}function U(t){return Object.keys(t)}function q(t,e,r){void 0===r&&(r=c);var n=K(t,r),i=K(e,r);return ht(i)?!!ht(n)&&i===n:ht(n)?n in i:U(n).every(function(t){return t in i&&q(n[t],i[t])})}function B(t){try{return ht(t)||"number"==typeof t?""+t:t.type}catch(t){throw new Error("Events must be strings or objects with a string event.type property.")}}function X(t){try{return ht(t)||"number"==typeof t?""+t:ut(t)?t.name:t.type}catch(t){throw new Error("Actions must be strings or objects with a string action.type property.")}}function H(t,e){try{return ct(t)?t:t.toString().split(e)}catch(e){throw new Error("'"+t+"' is not a valid state path.")}}function K(t,e){return G(t)?t.value:ct(t)?Q(t):"string"==typeof t||G(t)?Q(H(t,e)):t}function Q(t){if(1===t.length)return t[0];for(var e={},r=e,n=0;n<t.length-1;n++)n===t.length-2?r[t[n]]=t[n+1]:(r[t[n]]={},r=r[t[n]]);return e}function W(t,e){for(var r={},n=U(t),i=0;i<n.length;i++){var o=n[i];r[o]=e(t[o],o,t,i)}return r}function Y(t,e,r){var n,i,a={};try{for(var s=o(U(t)),c=s.next();!c.done;c=s.next()){var u=c.value,h=t[u];r(h)&&(a[u]=e(h,u,t))}}catch(t){n={error:t}}finally{try{c&&!c.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}return a}var Z=function(t){return function(e){var r,n,i=e;try{for(var a=o(t),s=a.next();!s.done;s=a.next()){i=i[s.value]}}catch(t){r={error:t}}finally{try{s&&!s.done&&(n=a.return)&&n.call(a)}finally{if(r)throw r.error}}return i}};var $=function(t){return t?ht(t)?[[t]]:tt(U(t).map(function(e){var r=t[e];return"string"==typeof r||Object.keys(r).length?$(t[e]).map(function(t){return[e].concat(t)}):[[e]]})):[[]]};function tt(t){var e;return(e=[]).concat.apply(e,s(t))}function et(t){return ct(t)?t:void 0===t?[]:[t]}function rt(t,e,r){var n,i;if(ut(t))return t(e,r);var a={};try{for(var s=o(U(t)),c=s.next();!c.done;c=s.next()){var u=c.value,h=t[u];ut(h)?a[u]=h(e,r):a[u]=h}}catch(t){n={error:t}}finally{try{c&&!c.done&&(i=s.return)&&i.call(s)}finally{if(n)throw n.error}}return a}function nt(t){return t instanceof Promise||!(null===t||!ut(t)&&"object"!=typeof t||!ut(t.then))}function it(t,e){var r,n,i=a([[],[]],2),s=i[0],c=i[1];try{for(var u=o(t),h=u.next();!h.done;h=u.next()){var l=h.value;e(l)?s.push(l):c.push(l)}}catch(t){r={error:t}}finally{try{h&&!h.done&&(n=u.return)&&n.call(u)}finally{if(r)throw r.error}}return[s,c]}function ot(t,e){return W(t.states,function(t,r){if(t){var n=(ht(e)?void 0:e[r])||(t?t.current:void 0);if(n)return{current:n,states:ot(t,n)}}})}function at(t,r,n){return t?n.reduce(function(t,n){var i,a,s=n.assignment,c={};if(ut(s))c=s(t,r||{type:e.Init});else try{for(var u=o(U(s)),h=u.next();!h.done;h=u.next()){var l=h.value,f=s[l];c[l]=ut(f)?f(t,r):f}}catch(t){i={error:t}}finally{try{h&&!h.done&&(a=u.return)&&a.call(u)}finally{if(i)throw i.error}}return Object.assign({},t,c)},t):t}var st=function(){};function ct(t){return Array.isArray(t)}function ut(t){return"function"==typeof t}function ht(t){return"string"==typeof t}var lt={deferEvents:!1},ft=function(){function t(t){this.processingEvent=!1,this.queue=[],this.initialized=!1,this.options=n({},lt,t)}return t.prototype.initialize=function(t){if(this.initialized=!0,t){if(!this.options.deferEvents)return void this.schedule(t);this.process(t)}this.flushEvents()},t.prototype.schedule=function(t){if(this.initialized&&!this.processingEvent){if(0!==this.queue.length)throw new Error("Event queue should be empty when it is not processing events");this.process(t),this.flushEvents()}else this.queue.push(t)},t.prototype.flushEvents=function(){for(var t=this.queue.shift();t;)this.process(t),t=this.queue.shift()},t.prototype.process=function(t){this.processingEvent=!0;try{t()}catch(t){throw this.queue=[],t}finally{this.processingEvent=!1}},t}(),dt=function(){function t(e,i){void 0===i&&(i=t.defaultOptions);var o=this;this.machine=e,this.scheduler=new ft,this.delayedEventsMap={},this.listeners=new Set,this.contextListeners=new Set,this.stopListeners=new Set,this.doneListeners=new Set,this.eventListeners=new Set,this.sendListeners=new Set,this.initialized=!1,this.children=new Map,this.forwardTo=new Set,this.init=this.start,this.send=function(t,e){if(ct(t))return o.batch(t),o.state;var r=E(t,e);if(!o.initialized&&o.options.deferEvents)st(!1,'Event "'+r.type+'" was sent to uninitialized service "'+o.machine.id+'" and is deferred. Make sure .start() is called for this service.\nEvent: '+JSON.stringify(t));else if(!o.initialized)throw new Error('Event "'+r.type+'" was sent to uninitialized service "'+o.machine.id+'". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.\nEvent: '+JSON.stringify(r));return o.scheduler.schedule(function(){var t=o.nextState(r);o.update(t,r),o.forward(r)}),o.state},this.sender=function(t){return function(){return this.send(t)}.bind(o)},this.sendTo=function(t,e){var n=e===r.Parent,i=n?o.parent:o.children.get(e);if(i)i.send(t);else{if(!n)throw new Error("Unable to send event to child '"+e+"' from service '"+o.id+"'.");st(!1,"Service '"+o.id+"' has no parent: unable to send event "+t.type)}};var a=n({},t.defaultOptions,i),s=a.clock,c=a.logger,u=a.parent,h=a.id,l=void 0!==h?h:e.id;Object.assign(this,{clock:s,logger:c,parent:u,id:l}),this.options=a,this.scheduler=new ft({deferEvents:this.options.deferEvents})}return Object.defineProperty(t.prototype,"initialState",{get:function(){return this.machine.initialState},enumerable:!0,configurable:!0}),t.prototype.execute=function(t){var e,r;try{for(var n=o(t.actions),i=n.next();!i.done;i=n.next()){var a=i.value;this.exec(a,t.context,t.event)}}catch(t){e={error:t}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(e)throw e.error}}},t.prototype.update=function(t,e){var r,n,i,a,s,c,u,h;if(this.state=t,this.options.execute&&this.execute(this.state),this.devTools&&this.devTools.send(e,t),t.event)try{for(var l=o(this.eventListeners),f=l.next();!f.done;f=l.next()){(0,f.value)(t.event)}}catch(t){r={error:t}}finally{try{f&&!f.done&&(n=l.return)&&n.call(l)}finally{if(r)throw r.error}}try{for(var d=o(this.listeners),v=d.next();!v.done;v=d.next()){(0,v.value)(t,t.event)}}catch(t){i={error:t}}finally{try{v&&!v.done&&(a=d.return)&&a.call(d)}finally{if(i)throw i.error}}try{for(var p=o(this.contextListeners),y=p.next();!y.done;y=p.next()){(0,y.value)(this.state.context,this.state.history?this.state.history.context:void 0)}}catch(t){s={error:t}}finally{try{y&&!y.done&&(c=p.return)&&c.call(p)}finally{if(s)throw s.error}}if(this.state.tree&&this.state.tree.done){var m=this.state.tree.getDoneData(this.state.context,E(e));try{for(var g=o(this.doneListeners),x=g.next();!x.done;x=g.next()){(0,x.value)(z(this.id,m))}}catch(t){u={error:t}}finally{try{x&&!x.done&&(h=g.return)&&h.call(g)}finally{if(u)throw u.error}}this.stop()}},t.prototype.onTransition=function(t){return this.listeners.add(t),this},t.prototype.onEvent=function(t){return this.eventListeners.add(t),this},t.prototype.onSend=function(t){return this.sendListeners.add(t),this},t.prototype.onChange=function(t){return this.contextListeners.add(t),this},t.prototype.onStop=function(t){return this.stopListeners.add(t),this},t.prototype.onDone=function(t){return this.doneListeners.add(t),this},t.prototype.off=function(t){return this.listeners.delete(t),this.eventListeners.delete(t),this.sendListeners.delete(t),this.stopListeners.delete(t),this.doneListeners.delete(t),this.contextListeners.delete(t),this},t.prototype.start=function(t){var e=this,r=void 0===t?this.machine.initialState:t instanceof h?this.machine.resolveState(t):this.machine.resolveState(h.from(t));return this.initialized=!0,this.options.devTools&&this.attachDev(),this.scheduler.initialize(function(){e.update(r,{type:x})}),this},t.prototype.stop=function(){var t,e,r,n,i,a,s,c,u,h;try{for(var l=o(this.listeners),f=l.next();!f.done;f=l.next()){var d=f.value;this.listeners.delete(d)}}catch(e){t={error:e}}finally{try{f&&!f.done&&(e=l.return)&&e.call(l)}finally{if(t)throw t.error}}try{for(var v=o(this.stopListeners),p=v.next();!p.done;p=v.next()){(d=p.value)(),this.stopListeners.delete(d)}}catch(t){r={error:t}}finally{try{p&&!p.done&&(n=v.return)&&n.call(v)}finally{if(r)throw r.error}}try{for(var y=o(this.contextListeners),m=y.next();!m.done;m=y.next()){d=m.value;this.contextListeners.delete(d)}}catch(t){i={error:t}}finally{try{m&&!m.done&&(a=y.return)&&a.call(y)}finally{if(i)throw i.error}}try{for(var g=o(this.doneListeners),x=g.next();!x.done;x=g.next()){d=x.value;this.doneListeners.delete(d)}}catch(t){s={error:t}}finally{try{x&&!x.done&&(c=g.return)&&c.call(g)}finally{if(s)throw s.error}}this.children.forEach(function(t){ut(t.stop)&&t.stop()});try{for(var w=o(U(this.delayedEventsMap)),S=w.next();!S.done;S=w.next()){var b=S.value;this.clock.clearTimeout(this.delayedEventsMap[b])}}catch(t){u={error:t}}finally{try{S&&!S.done&&(h=w.return)&&h.call(w)}finally{if(u)throw u.error}}return this.initialized=!1,this},t.prototype.batch=function(t){var e=this;if(!this.initialized&&this.options.deferEvents)st(!1,t.length+' event(s) were sent to uninitialized service "'+this.machine.id+'" and are deferred. Make sure .start() is called for this service.\nEvent: '+JSON.stringify(event));else if(!this.initialized)throw new Error(t.length+' event(s) were sent to uninitialized service "'+this.machine.id+'". Make sure .start() is called for this service, or set { deferEvents: true } in the service options.');this.scheduler.schedule(function(){var r,i,a,c=e.state;try{for(var u=o(t),h=u.next();!h.done;h=u.next()){var l=E(h.value),f=c.actions.map(function(t){return r=c,i=(e=t).exec,n({},e,{exec:void 0!==i?function(){return i(r.context,r.event,{action:e,state:r})}:void 0});var e,r,i});(a=(c=e.machine.transition(c,l)).actions).unshift.apply(a,s(f)),e.forward(l)}}catch(t){r={error:t}}finally{try{h&&!h.done&&(i=u.return)&&i.call(u)}finally{if(r)throw r.error}}e.update(c,E(t[t.length-1]))})},t.prototype.nextState=function(t){var e=E(t);if(e.type===S&&-1===this.state.nextEvents.indexOf(S))throw e.data;return this.machine.transition(this.state,e,this.state.context)},t.prototype.forward=function(t){var e,r;try{for(var n=o(this.forwardTo),i=n.next();!i.done;i=n.next()){var a=i.value,s=this.children.get(a);if(!s)throw new Error("Unable to forward event '"+t+"' from interpreter '"+this.id+"' to nonexistant child '"+a+"'.");s.send(t)}}catch(t){e={error:t}}finally{try{i&&!i.done&&(r=n.return)&&r.call(n)}finally{if(e)throw e.error}}},t.prototype.defer=function(t){var e=this,r=t.delay;if(ht(r)){if(!this.machine.options.delays||void 0===this.machine.options.delays[r])return void st(!1,"No delay reference for delay expression '"+r+"' was found on machine '"+this.machine.id+"' on service '"+this.id+"'.");var n=this.machine.options.delays[r];r="number"==typeof n?n:n(this.state.context,this.state.event)}this.delayedEventsMap[t.id]=this.clock.setTimeout(function(){t.to?e.sendTo(t.event,t.to):e.send(t.event)},r||0)},t.prototype.cancel=function(t){this.clock.clearTimeout(this.delayedEventsMap[t]),delete this.delayedEventsMap[t]},t.prototype.exec=function(t,r,n){if(t.exec)return t.exec(r,n,{action:t,state:this.state});switch(t.type){case v:var i=t;if(i.delay)return void this.defer(i);i.to?this.sendTo(i.event,i.to):this.send(i.event);break;case p:this.cancel(t.sendId);break;case l:var o=t.activity;if(!this.state.activities[o.type])break;if(o.type===e.Invoke){var a=this.machine.options.services?this.machine.options.services[o.src]:void 0,s=o.id,c=o.data,u=!!o.forward;if(!a)return void st(!1,"No service found for invocation '"+o.src+"' in machine '"+this.machine.id+"'.");var h=ut(a)?a(r,n):a;nt(h)?this.spawnPromise(s,Promise.resolve(h)):ut(h)?this.spawnCallback(s,h):"string"!=typeof h&&this.spawn(c?h.withContext(rt(c,r,n)):h,{id:s,autoForward:u})}else this.spawnActivity(o);break;case f:this.stopChild(t.activity.id);break;case g:var d=t.expr?t.expr(r,n):void 0;t.label?this.logger(t.label,d):this.logger(d);break;default:st(!1,"No implementation found for action type '"+t.type+"'")}},t.prototype.stopChild=function(t){var e=this.children.get(t);e&&ut(e.stop)&&(e.stop(),this.children.delete(t),this.forwardTo.delete(t))},t.prototype.spawn=function(e,r){var n=this;void 0===r&&(r={});var i=new t(e,{parent:this,id:r.id||e.id});return i.onDone(function(t){n.send(t)}).start(),this.children.set(i.id,i),r.autoForward&&this.forwardTo.add(i.id),i},t.prototype.spawnPromise=function(t,e){var r=this,n=!1;e.then(function(e){n||r.send(z(t,e))}).catch(function(e){if(!n){var i=L(e,t);try{r.send(i)}catch(t){r.devTools&&r.devTools.send(i,r.state),r.machine.strict&&r.stop()}}}),this.children.set(t,{send:function(){},stop:function(){n=!0}})},t.prototype.spawnCallback=function(t,e){var r,n=this,i=function(e){st(!1,"Event '"+e.type+"' sent to callback service '"+t+"' but was not handled by a listener.")};try{nt(r=e(function(t){return n.send(t)},function(t){i=t}))&&Promise.resolve(r).catch(function(e){var r=L(e,t);try{n.send(r)}catch(t){n.devTools&&n.devTools.send(r,n.state),n.machine.strict&&n.stop()}})}catch(e){this.send(L(e,t))}this.children.set(t,{send:i,stop:r})},t.prototype.spawnActivity=function(t){var e=this.machine.options&&this.machine.options.activities?this.machine.options.activities[t.type]:void 0;if(e){var r=e(this.state.context,t);this.spawnEffect(t.id,r)}else st(!1,"No implementation found for activity '"+t.type+"'")},t.prototype.spawnEffect=function(t,e){this.children.set(t,{send:function(){},stop:e})},t.prototype.reportUnhandledExceptionOnInvocation=function(t,e,r){var n=t.stack?" Stacktrace was '"+t.stack+"'":"";if(t===e)console.error("Missing onError handler for invocation '"+r+"', error was '"+t+"'."+n);else{var i=e.stack?" Stacktrace was '"+e.stack+"'":"";console.error("Missing onError handler and/or unhandled exception/promise rejection for invocation '"+r+"'. Original error: '"+t+"'. "+n+" Current error is '"+e+"'."+i)}},t.prototype.attachDev=function(){this.options.devTools&&"undefined"!=typeof window&&window.__REDUX_DEVTOOLS_EXTENSION__&&(this.devTools=window.__REDUX_DEVTOOLS_EXTENSION__.connect({name:this.id,features:{jump:!1,skip:!1}}),this.devTools.init(this.state))},t.defaultOptions=function(t){return{execute:!0,deferEvents:!0,clock:{setTimeout:function(e,r){return t.setTimeout.call(null,e,r)},clearTimeout:function(e){return t.clearTimeout.call(null,e)}},logger:t.console.log.bind(console),devTools:!1}}("undefined"==typeof window?global:window),t.interpret=vt,t}();function vt(t,e){return new dt(t,e)}var pt={};function yt(t,e){return tt(t.definition.on[e].map(function(r){var n=r.target?[].concat(r.target):void 0;return n?n.map(function(n){try{var i=n?t.getRelativeStateNodes(n,void 0,!1)[0]:t;return{source:t,target:i,event:e,actions:r.actions?r.actions.map(X):[],cond:r.cond,transition:r}}catch(e){return void st(e,"Target '"+n+"' not found on '"+t.id+"'")}}).filter(function(t){return void 0!==t}):[{source:t,target:t,event:e,actions:r.actions?r.actions.map(X):[],cond:r.cond,transition:r}]}))}function mt(t){var e=a(t.split(" | "),2),r=e[0],n=e[1];return{value:JSON.parse(r),context:void 0===n?void 0:JSON.parse(n)}}function gt(t){var e=t.value,r=t.context;return void 0===r?JSON.stringify(e):JSON.stringify(e)+" | "+JSON.stringify(r)}function xt(t){return JSON.stringify(t)}function wt(t){return JSON.parse(t)}var St={events:{},filter:function(){return!0},stateSerializer:gt,eventSerializer:xt},bt=function(){function t(t,e){this.machine=t,this.options=n({events:{},stateSerializer:gt,eventSerializer:xt},e),this.mapping=Et(t,e)}return t.prototype.reaches=function(t,e){var r=this.machine.resolve(t),n=h.from(r,e);return!!this.mapping[this.options.stateSerializer(n)]},t}();function Et(t,e){var r,i,a=n({events:{},stateSerializer:gt,eventSerializer:xt},e),s=a.filter,c=a.stateSerializer,u=a.eventSerializer,h={};try{for(var l=o(t.events),f=l.next();!f.done;f=l.next()){var d=f.value;h[d]=[d]}}catch(t){r={error:t}}finally{try{f&&!f.done&&(i=l.return)&&i.call(l)}finally{if(r)throw r.error}}Object.assign(h,a.events);var v={};return function e(r){var n,i,a=r.nextEvents,l=c(r);if(!v[l]){v[l]={};var f=tt(a.map(function(t){return h[t]||[]})).map(function(t){return E(t)});try{for(var d=o(f),p=d.next();!p.done;p=d.next()){var y=p.value,m=t.transition(r,y);s&&!s(m)||l===c(m)||(v[l][u(y)]=m,e(m))}}catch(t){n={error:t}}finally{try{p&&!p.done&&(i=d.return)&&i.call(d)}finally{if(n)throw n.error}}}}(t.initialState),v}function Nt(t,e){if(void 0===e&&(e=St),!t.states)return pt;var r=Et(t,e),n={},i=new Set;return function t(e){var a,c,u,l,f=gt(e);i.add(f);var d=r[f];try{for(var v=o(U(d)),p=v.next();!p.done;p=v.next()){var y=p.value,m=d[y],g=m.value,x=m.context;if(g){var w=gt(O=h.from(g,x));(!n[w]||n[w].length>n[f].length+1)&&(n[w]=s(n[f]||[],[{state:{value:g,context:e.context},event:wt(y)}]))}}}catch(t){a={error:t}}finally{try{p&&!p.done&&(c=v.return)&&c.call(v)}finally{if(a)throw a.error}}try{for(var S=o(U(d)),b=S.next();!b.done;b=S.next()){var E=d[b.value],N=(g=E.value,E.context);if(g){var O=h.from(g,N);w=gt(h.from(g,N)),i.has(w)||t(O)}}}catch(t){u={error:t}}finally{try{b&&!b.done&&(l=S.return)&&l.call(S)}finally{if(u)throw u.error}}return n}(t.initialState),n}function Ot(t,e){var r,n;if(!t.states)return pt;var i=Et(t,e),a=new Set,c=[],u={};function h(t,e){var r,n;if(a.add(t),t===e)u[e]||(u[e]={state:mt(e),paths:[]}),u[e].paths.push(s(c));else try{for(var l=o(U(i[t])),f=l.next();!f.done;f=l.next()){var d=f.value,v=i[t][d];if(v){var p=gt(v);a.has(p)||(c.push({state:mt(t),event:wt(d)}),h(p,e))}}}catch(t){r={error:t}}finally{try{f&&!f.done&&(n=l.return)&&n.call(l)}finally{if(r)throw r.error}}c.pop(),a.delete(t)}var l=gt(t.initialState);try{for(var f=o(U(i)),d=f.next();!d.done;d=f.next()){h(l,d.value)}}catch(t){r={error:t}}finally{try{d&&!d.done&&(n=f.return)&&n.call(f)}finally{if(r)throw r.error}}return u}t.getNodes=function t(e){var r=e.states;return U(r).reduce(function(e,n){var i=r[n],o=t(r[n]);return e.push.apply(e,s([i],o)),e},[])},t.getEventEdges=yt,t.getEdges=function t(e,r){var n,i,a,c,u,h,l=(r||{}).depth,f=void 0===l?null:l,d=[];if(e.states&&null===f)try{for(var v=o(U(e.states)),p=v.next();!p.done;p=v.next()){var y=p.value;d.push.apply(d,s(t(e.states[y])))}}catch(t){n={error:t}}finally{try{p&&!p.done&&(i=v.return)&&i.call(v)}finally{if(n)throw n.error}}else if(f&&f>0)try{for(var m=o(U(e.states)),g=m.next();!g.done;g=m.next())y=g.value,d.push.apply(d,s(t(e.states[y],{depth:f-1})))}catch(t){a={error:t}}finally{try{g&&!g.done&&(c=m.return)&&c.call(m)}finally{if(a)throw a.error}}try{for(var x=o(U(e.on)),w=x.next();!w.done;w=x.next()){var S=w.value;d.push.apply(d,s(yt(e,S)))}}catch(t){u={error:t}}finally{try{w&&!w.done&&(h=x.return)&&h.call(x)}finally{if(u)throw u.error}}return d},t.getAdjacencyMap=function(t,e){var r={},n=t.events;return function i(a){var s,c,u=JSON.stringify(a);if(!r[u]){r[u]={};try{for(var h=o(n),l=h.next();!l.done;l=h.next()){var f=l.value,d=t.transition(a,f,e);r[u][f]={state:d.value},i(d.value)}}catch(t){s={error:t}}finally{try{l&&!l.done&&(c=h.return)&&c.call(h)}finally{if(s)throw s.error}}}}(t.initialState.value),r},t.deserializeStateString=mt,t.serializeState=gt,t.serializeEvent=xt,t.deserializeEventString=wt,t.ValueAdjacency=bt,t.getValueAdjacencyMap=Et,t.getShortestValuePaths=Nt,t.getShortestPathsAsArray=function(t){var e=Nt(t,St);return U(e).map(function(t){return{state:JSON.parse(t),path:e[t]}})},t.getSimplePaths=Ot,t.getSimplePathsAsArray=function(t,e){var r=Ot(t,e);return U(r).map(function(t){return r[t]})},Object.defineProperty(t,"__esModule",{value:!0})});
