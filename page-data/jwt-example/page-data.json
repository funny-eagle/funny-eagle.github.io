{"componentChunkName":"component---src-templates-blog-post-js","path":"/jwt-example/","result":{"data":{"site":{"siteMetadata":{"title":"Funny Eagle","author":"Jason Yang"}},"markdownRemark":{"id":"49398d8c-d9b1-50ab-91d6-67bc4a9194e5","excerpt":"上一篇【JWT】JSON Web Token 入门简介中，我们了解了什么是 JWT 以及使用场景等。本示例项目中，我们会搭建一个spring-boot 应用，利用 JWT 身份验证来保护公开的 RE…","html":"<blockquote>\n<p>上一篇<a href=\"http://www.funnyeagle.cn/Introduction-to-jwt/\">【JWT】JSON Web Token 入门简介</a>中，我们了解了什么是 JWT 以及使用场景等。本示例项目中，我们会搭建一个<code>spring-boot</code> 应用，利用 <code>JWT</code> 身份验证来保护公开的 <code>REST API</code>。该项目没有使用数据库，用硬编码的用户名和密码进行用户身份验证。只有客户端发起携带有效的 <code>JSON Web Token</code> （JWT） 请求时，它才能使用此 API。</p>\n</blockquote>\n<p>项目类图如下：\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0da4b5e702886e846afb206a62b680ae/37f8f/jwt-uml.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 61.48648648648649%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABvElEQVR42m1RWXKrMBD0cdAAQexYQhJCK4sNXl7l3f8kCWCn8pGpril9TGumu08IAAUBCgIAhBAQUitjuVSUMdLyqsq1dVKZsq7KqirLMoqi8F2noqoo54yLummCABkplsc/5QZpnDSek2a5PfRwcVbPy83PC8YpALzIlNJtThnScgTQcXG9f87r0wxzpy1tyLTe9XDx1s3r3U3XLMsB0IsMsB0eRREABEEgGb89/0/rU2rLpCJ17eer9jNnglBWVHUcx4De5L1HKcZJipME53mepllZlaRllPEzoYS2xSb1xYn3epHjKPRW2/HSW2/coIxTZvBazsvNjhepjJ/XXhlrjB4m7by2vjdOSEVbdorCUHDeKUNbTpk4IIXw46zdyITk+xxjnAm53UJZfaakZWVVb2cjhI6o3iFAknw05zNhvGWCcVEUJdqsgRBgTzTYgXbNUfQ7PQSQp8njfrs8PrX10/Loev1jUhhGb2xuw2748e/xgAyny3Kf1qd2o5uurJM/2f6uU4JxludZlsUfSZbnGGMAiOO4rpuqbrK8KPce/knuezXM106Zc9PYYWS8O5YcwjaBCP259pv8BbkQmidCVfPvAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"jwt-uml\"\n        title=\"\"\n        src=\"/static/0da4b5e702886e846afb206a62b680ae/fcda8/jwt-uml.png\"\n        srcset=\"/static/0da4b5e702886e846afb206a62b680ae/12f09/jwt-uml.png 148w,\n/static/0da4b5e702886e846afb206a62b680ae/e4a3f/jwt-uml.png 295w,\n/static/0da4b5e702886e846afb206a62b680ae/fcda8/jwt-uml.png 590w,\n/static/0da4b5e702886e846afb206a62b680ae/efc66/jwt-uml.png 885w,\n/static/0da4b5e702886e846afb206a62b680ae/c83ae/jwt-uml.png 1180w,\n/static/0da4b5e702886e846afb206a62b680ae/37f8f/jwt-uml.png 3056w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>就这么几个类，下面直接开始吧！</p>\n<h4 id=\"1创建一个spring-boot项目配置maven坐标需要使用到-spring-boot-starter-webspring-boot-starter-security-以及-jwt为了简化代码使用了lombok\" style=\"position:relative;\"><a href=\"#1%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAspring-boot%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AEmaven%E5%9D%90%E6%A0%87%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8%E5%88%B0-spring-boot-starter-webspring-boot-starter-security-%E4%BB%A5%E5%8F%8A-jwt%E4%B8%BA%E4%BA%86%E7%AE%80%E5%8C%96%E4%BB%A3%E7%A0%81%E4%BD%BF%E7%94%A8%E4%BA%86lombok\" aria-label=\"1创建一个spring boot项目配置maven坐标需要使用到 spring boot starter webspring boot starter security 以及 jwt为了简化代码使用了lombok permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1、创建一个spring-boot项目，配置maven坐标，需要使用到 spring-boot-starter-web、spring-boot-starter-security 以及 jwt，为了简化代码，使用了lombok。</h4>\n<p>完整的pom.xml 如下：</p>\n<deckgo-highlight-code language=\"xml\" terminal=\"carbon\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;\n&lt;project xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;\n         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;\n    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;\n    &lt;parent&gt;\n        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n        &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;\n        &lt;version&gt;2.5.0&lt;/version&gt;\n        &lt;relativePath/&gt; &lt;!-- lookup parent from repository --&gt;\n    &lt;/parent&gt;\n    &lt;groupId&gt;cn.funnyealge&lt;/groupId&gt;\n    &lt;artifactId&gt;jwt-example&lt;/artifactId&gt;\n    &lt;version&gt;0.0.1-SNAPSHOT&lt;/version&gt;\n    &lt;name&gt;jwt-example&lt;/name&gt;\n    &lt;description&gt;Demo project for Spring Boot&lt;/description&gt;\n    &lt;properties&gt;\n        &lt;java.version&gt;8&lt;/java.version&gt;\n    &lt;/properties&gt;\n    &lt;dependencies&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;\n            &lt;artifactId&gt;jjwt&lt;/artifactId&gt;\n            &lt;version&gt;0.9.1&lt;/version&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;\n            &lt;artifactId&gt;lombok&lt;/artifactId&gt;\n            &lt;optional&gt;true&lt;/optional&gt;\n        &lt;/dependency&gt;\n        &lt;dependency&gt;\n            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;\n            &lt;scope&gt;test&lt;/scope&gt;\n        &lt;/dependency&gt;\n    &lt;/dependencies&gt;\n\n    &lt;build&gt;\n        &lt;plugins&gt;\n            &lt;plugin&gt;\n                &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;\n                &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;\n                &lt;configuration&gt;\n                    &lt;image&gt;\n                        &lt;builder&gt;paketobuildpacks/builder-jammy-base:latest&lt;/builder&gt;\n                    &lt;/image&gt;\n                    &lt;excludes&gt;\n                        &lt;exclude&gt;\n                            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;\n                            &lt;artifactId&gt;lombok&lt;/artifactId&gt;\n                        &lt;/exclude&gt;\n                    &lt;/excludes&gt;\n                &lt;/configuration&gt;\n            &lt;/plugin&gt;\n        &lt;/plugins&gt;\n    &lt;/build&gt;\n    &lt;repositories&gt;\n        &lt;repository&gt;\n            &lt;id&gt;spring-milestones&lt;/id&gt;\n            &lt;name&gt;Spring Milestones&lt;/name&gt;\n            &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt;\n            &lt;snapshots&gt;\n                &lt;enabled&gt;false&lt;/enabled&gt;\n            &lt;/snapshots&gt;\n        &lt;/repository&gt;\n        &lt;repository&gt;\n            &lt;id&gt;spring-snapshots&lt;/id&gt;\n            &lt;name&gt;Spring Snapshots&lt;/name&gt;\n            &lt;url&gt;https://repo.spring.io/snapshot&lt;/url&gt;\n            &lt;releases&gt;\n                &lt;enabled&gt;false&lt;/enabled&gt;\n            &lt;/releases&gt;\n        &lt;/repository&gt;\n    &lt;/repositories&gt;\n    &lt;pluginRepositories&gt;\n        &lt;pluginRepository&gt;\n            &lt;id&gt;spring-milestones&lt;/id&gt;\n            &lt;name&gt;Spring Milestones&lt;/name&gt;\n            &lt;url&gt;https://repo.spring.io/milestone&lt;/url&gt;\n            &lt;snapshots&gt;\n                &lt;enabled&gt;false&lt;/enabled&gt;\n            &lt;/snapshots&gt;\n        &lt;/pluginRepository&gt;\n        &lt;pluginRepository&gt;\n            &lt;id&gt;spring-snapshots&lt;/id&gt;\n            &lt;name&gt;Spring Snapshots&lt;/name&gt;\n            &lt;url&gt;https://repo.spring.io/snapshot&lt;/url&gt;\n            &lt;releases&gt;\n                &lt;enabled&gt;false&lt;/enabled&gt;\n            &lt;/releases&gt;\n        &lt;/pluginRepository&gt;\n    &lt;/pluginRepositories&gt;\n\n&lt;/project&gt;\n</code>\n        </deckgo-highlight-code>\n<h4 id=\"2spring-boot工程搭建好之后创建一个hellocontroller写一个get请求的-rest-api-hello\" style=\"position:relative;\"><a href=\"#2spring-boot%E5%B7%A5%E7%A8%8B%E6%90%AD%E5%BB%BA%E5%A5%BD%E4%B9%8B%E5%90%8E%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAhellocontroller%E5%86%99%E4%B8%80%E4%B8%AAget%E8%AF%B7%E6%B1%82%E7%9A%84-rest-api-hello\" aria-label=\"2spring boot工程搭建好之后创建一个hellocontroller写一个get请求的 rest api hello permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2、spring-boot工程搭建好之后，创建一个HelloController，写一个GET请求的 REST API <code>/hello</code></h4>\n<deckgo-highlight-code language=\"java\" terminal=\"carbon\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">package cn.funnyealge.jwt.controller;\n\nimport org.springframework.web.bind.annotation.GetMapping;\nimport org.springframework.web.bind.annotation.RestController;\n\n/**\n * @author yangjl\n * @description Hello Controller\n * @date 2023-11-15 10:43\n **/\n@RestController\npublic class HelloController {\n\n    @GetMapping(&quot;/hello&quot;)\n    public String hello() {\n        return &quot;Hello, World!&quot;;\n    }\n}\n</code>\n        </deckgo-highlight-code>\n<p>此时启动项目的话，通过 <code>http://localhost:8080/hello</code> 可以直接访问到这个API的。</p>\n<h4 id=\"3接下来开始配置spring-security-和-jwt\" style=\"position:relative;\"><a href=\"#3%E6%8E%A5%E4%B8%8B%E6%9D%A5%E5%BC%80%E5%A7%8B%E9%85%8D%E7%BD%AEspring-security-%E5%92%8C-jwt\" aria-label=\"3接下来开始配置spring security 和 jwt permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3、接下来开始配置spring security 和 JWT。</h4>\n<p>3.1 创建<code>JwtUtil</code>类，用于创建、验证<code>JWT</code>以及获取<code>JWT</code>中的信息。</p>\n<deckgo-highlight-code language=\"java\" terminal=\"carbon\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">package cn.funnyealge.jwt.config;\n\nimport io.jsonwebtoken.Claims;\nimport io.jsonwebtoken.Jwts;\nimport io.jsonwebtoken.SignatureAlgorithm;\nimport org.springframework.beans.factory.annotation.Value;\nimport org.springframework.security.core.userdetails.UserDetails;\nimport org.springframework.stereotype.Component;\n\nimport java.io.Serializable;\nimport java.util.Date;\nimport java.util.HashMap;\nimport java.util.Map;\nimport java.util.function.Function;\n\n/**\n * @author yangjl\n * @description jwt util\n * @date 2023-11-15 11:21\n **/\n@Component\npublic class JwtUtil implements Serializable {\n    public static final long JWT_TOKEN_VALIDITY = 5 * 60 * 60;\n    private static final long serialVersionUID = 1L;\n    @Value(&quot;${jwt.secret}&quot;)\n    private String secret;\n\n    /**\n     * 从token中获取username\n     */\n    public String getUserNameFromToken(String token) {\n        return getClaimFromToken(token, Claims::getSubject);\n    }\n\n    /**\n     * 从token中获取过期时间\n     *\n     * @param token\n     * @return\n     */\n    public Date getExpirationDateFromToken(String token) {\n        return getClaimFromToken(token, Claims::getExpiration);\n    }\n\n    public &lt;T&gt; T getClaimFromToken(String token, Function&lt;Claims, T&gt; claimsResolver) {\n        Claims claims = getAllClaimsFromToken(token);\n        return claimsResolver.apply(claims);\n    }\n\n    /**\n     * 从token中获取信息\n     *\n     * @param token\n     * @return\n     */\n    private Claims getAllClaimsFromToken(String token) {\n        return Jwts.parser().setSigningKey(secret).parseClaimsJws(token).getBody();\n    }\n\n    /**\n     * 检查token是否过期\n     *\n     * @param token\n     * @return\n     */\n    private boolean isTokenExpired(String token) {\n        Date expiration = getExpirationDateFromToken(token);\n        return expiration.before(new Date());\n    }\n\n\n    public String generateToken(UserDetails userDetails) {\n        Map&lt;String, Object&gt; claims = new HashMap&lt;&gt;(16);\n        return doGenerateToken(claims, userDetails.getUsername());\n    }\n\n    /**\n     * 使用Jwts生成Token\n     *\n     * @param claims\n     * @param subject\n     * @return\n     */\n    private String doGenerateToken(Map&lt;String, Object&gt; claims, String subject) {\n        return Jwts.builder()\n                .setClaims(claims)\n                .setSubject(subject)\n                .setIssuedAt(new Date(System.currentTimeMillis()))\n                .setExpiration(new Date(System.currentTimeMillis() + JWT_TOKEN_VALIDITY * 1000))\n                .signWith(SignatureAlgorithm.HS512, secret)\n                .compact();\n    }\n\n    /**\n     * 验证token\n     *\n     * @param token\n     * @param userDetails\n     * @return\n     */\n    public Boolean validateToken(String token, UserDetails userDetails) {\n        String username = getUserNameFromToken(token);\n        return username.equals(userDetails.getUsername()) &amp;&amp; !isTokenExpired(token);\n    }\n\n}\n</code>\n        </deckgo-highlight-code>\n<p>3.2 创建<code>JWTUserDetailsService</code>类,实现了 spring security 的UserDetailsService 接口，重写loadUserByUsername方法，通过用户名获取用户详细信息，此处没有使用数据库，使用硬编码的方式定义了一个用户，实际应用中应该从数据库中查询用户信息。其中密码是经过<code>bcrypt</code>加密的，如果需要修改，搜一个在线Bcrypt密码生成工具生成替换一下就可以。</p>\n<deckgo-highlight-code language=\"java\" terminal=\"carbon\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">package cn.funnyealge.jwt.service;\n\nimport org.springframework.security.core.userdetails.User;\nimport org.springframework.security.core.userdetails.UserDetails;\nimport org.springframework.security.core.userdetails.UserDetailsService;\nimport org.springframework.security.core.userdetails.UsernameNotFoundException;\nimport org.springframework.stereotype.Service;\n\nimport java.util.ArrayList;\n\n/**\n * @author yangjl\n * @description\n * @date 2023-11-15 13:34\n **/\n@Service\npublic class JtwUserDetailService implements UserDetailsService {\n    @Override\n    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {\n        if (&quot;funnyeagle&quot;.equals(username)) {\n            return new User(&quot;funnyeagle&quot;, &quot;$2a$10$JQEWsaUWgp6zYk1cvLvHMuM6kcLbmAdWPrp9QCSNYswu.kFum9PIq&quot;, new ArrayList&lt;&gt;());\n        }\n\n        throw new UsernameNotFoundException(&quot;User not found with username:&quot; + username);\n    }\n}\n</code>\n        </deckgo-highlight-code>\n<p>3.3 创建<code>JwtRequest</code>类，包含用户名和密码，客户端向服务端发送请求时使用。</p>\n<deckgo-highlight-code language=\"java\" terminal=\"carbon\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">package cn.funnyealge.jwt.model;\n\nimport lombok.Data;\n\nimport java.io.Serializable;\n\n/**\n * @author yangjl\n * @description\n * @date 2023-11-15 13:50\n **/\n@Data\npublic class JwtRequest implements Serializable {\n    private static final long serialVersionUID = 1L;\n\n    private String username;\n    private String password;\n}</code>\n        </deckgo-highlight-code>\n<p>3.4 创建<code>JwtResponse</code>类，包含token属性，用于向客户端返回数据</p>\n<deckgo-highlight-code language=\"java\" terminal=\"carbon\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">package cn.funnyealge.jwt.model;\n\nimport lombok.Data;\n\nimport java.io.Serializable;\n\n/**\n * @author yangjl\n * @description\n * @date 2023-11-15 13:52\n **/\n@Data\npublic class JwtResponse implements Serializable {\n    private static final long serialVersionUID = 1L;\n\n    private final String token;\n\n    public JwtResponse(String token) {\n        this.token = token;\n    }\n}\n</code>\n        </deckgo-highlight-code>\n<p>3.5 创建<code>JwtAuthenticationController</code>类，包含一个POST <code>/authenticate</code> API，调用<code>AuthenticationManager</code>的<code>authenticate()</code>方法对用户名和密码进行验证，验证通过则使用JwtUtil创建JWT token返回给客户端。</p>\n<deckgo-highlight-code language=\"java\" terminal=\"carbon\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">package cn.funnyealge.jwt.controller;\n\nimport cn.funnyealge.jwt.config.JwtUtil;\nimport cn.funnyealge.jwt.model.JwtRequest;\nimport cn.funnyealge.jwt.model.JwtResponse;\nimport cn.funnyealge.jwt.service.JtwUserDetailService;\nimport org.springframework.http.ResponseEntity;\nimport org.springframework.security.authentication.AuthenticationManager;\nimport org.springframework.security.authentication.BadCredentialsException;\nimport org.springframework.security.authentication.DisabledException;\nimport org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\nimport org.springframework.security.core.userdetails.UserDetails;\nimport org.springframework.web.bind.annotation.CrossOrigin;\nimport org.springframework.web.bind.annotation.PostMapping;\nimport org.springframework.web.bind.annotation.RequestBody;\nimport org.springframework.web.bind.annotation.RestController;\n\nimport javax.annotation.Resource;\n\n/**\n * @author yangjl\n * @description\n * @date 2023-11-15 13:43\n **/\n@RestController\n@CrossOrigin\npublic class JwtAuthenticationController {\n\n    @Resource\n    private AuthenticationManager authenticationManager;\n\n    @Resource\n    private JwtUtil jwtUtil;\n\n    @Resource\n    private JtwUserDetailService userDetailService;\n\n    @PostMapping(value = &quot;/authenticate&quot;)\n    public ResponseEntity&lt;?&gt; createAuthenticationToken(@RequestBody JwtRequest authenticationRequest) throws Exception {\n        authenticate(authenticationRequest.getUsername(), authenticationRequest.getPassword());\n        UserDetails userDetails = userDetailService.loadUserByUsername(authenticationRequest.getUsername());\n        String token = jwtUtil.generateToken(userDetails);\n        return ResponseEntity.ok(new JwtResponse(token));\n    }\n\n    private void authenticate(String username, String password) throws Exception {\n        try {\n            authenticationManager.authenticate(new UsernamePasswordAuthenticationToken(username, password));\n        } catch (DisabledException e) {\n            throw new Exception(&quot;user disabled&quot;, e);\n        } catch (BadCredentialsException e) {\n            throw new Exception(&quot;invalid credentials&quot;, e);\n        }\n    }\n}\n</code>\n        </deckgo-highlight-code>\n<p>3.6 创建<code>JwtRequestFilter</code>类，继承自spring的OncePerRequestFilter类，任何请求过来都会执行这个Filter，用来检查token的有效性，验证通过后，将用户信息设置到security的上下文中。</p>\n<deckgo-highlight-code language=\"java\" terminal=\"carbon\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">package cn.funnyealge.jwt.config;\n\nimport cn.funnyealge.jwt.service.JtwUserDetailService;\nimport io.jsonwebtoken.ExpiredJwtException;\nimport org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\nimport org.springframework.security.core.context.SecurityContextHolder;\nimport org.springframework.security.core.userdetails.UserDetails;\nimport org.springframework.security.web.authentication.WebAuthenticationDetailsSource;\nimport org.springframework.stereotype.Component;\nimport org.springframework.web.filter.OncePerRequestFilter;\n\nimport javax.annotation.Resource;\nimport javax.servlet.FilterChain;\nimport javax.servlet.ServletException;\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\nimport java.io.IOException;\n\n/**\n * JwtRequestFilter 继承了 Spring Web Filter OncePerRequestFilter 类。\n * 对于任何传入请求，都会执行此 Filter 类。它检查请求是否具有有效的 JWT 令牌。\n * 如果它具有有效的 JWT 令牌，则它会在上下文中设置身份验证，以指定当前用户已通过身份验证。\n *\n * @author yangjl\n * @description\n * @date 2023-11-15 13:54\n **/\n@Component\npublic class JwtRequestFilter extends OncePerRequestFilter {\n\n    @Resource\n    private JtwUserDetailService userDetailService;\n\n    @Resource\n    private JwtUtil jwtUtil;\n\n\n    @Override\n    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws ServletException, IOException {\n        final String requestTokenHeader = request.getHeader(&quot;Authorization&quot;);\n\n        String username = null;\n        String jwtToken = null;\n        if (requestTokenHeader != null &amp;&amp; requestTokenHeader.startsWith(&quot;Bearer &quot;)) {\n            jwtToken = requestTokenHeader.substring(7);\n            try {\n                username = jwtUtil.getUserNameFromToken(jwtToken);\n            } catch (IllegalArgumentException e) {\n                System.out.println(&quot;Unable to get JWT Token&quot;);\n            } catch (ExpiredJwtException e) {\n                System.out.println(&quot;JWT Token has expired&quot;);\n            }\n        } else {\n            logger.warn(&quot;JWT Token does not begin with Bearer String&quot;);\n        }\n\n        if (username != null &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == null) {\n\n            UserDetails userDetails = this.userDetailService.loadUserByUsername(username);\n\n            if (jwtUtil.validateToken(jwtToken, userDetails)) {\n\n                UsernamePasswordAuthenticationToken usernamePasswordAuthenticationToken = new UsernamePasswordAuthenticationToken(\n                        userDetails, null, userDetails.getAuthorities());\n                usernamePasswordAuthenticationToken\n                        .setDetails(new WebAuthenticationDetailsSource().buildDetails(request));\n                SecurityContextHolder.getContext().setAuthentication(usernamePasswordAuthenticationToken);\n            }\n        }\n        chain.doFilter(request, response);\n    }\n}\n</code>\n        </deckgo-highlight-code>\n<p>3.7 创建<code>JwtAuthenticationEntryPoint</code>类，继承spring的<code>AuthenticationEntryPoint</code>类，重写<code>commence</code>方法，用于拒绝未经身份验证的请求并返回错误码401。</p>\n<deckgo-highlight-code language=\"java\" terminal=\"carbon\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">package cn.funnyealge.jwt.config;\n\nimport org.springframework.security.core.AuthenticationException;\nimport org.springframework.security.web.AuthenticationEntryPoint;\nimport org.springframework.stereotype.Component;\n\nimport javax.servlet.http.HttpServletRequest;\nimport javax.servlet.http.HttpServletResponse;\nimport java.io.IOException;\nimport java.io.Serializable;\n\n/**\n * 此类继承 Spring 的 AuthenticationEntryPoint 类，拒绝未经身份验证的请求并返回错误代码 401\n *\n * @author yangjl\n * @description\n * @date 2023-11-15 14:02\n **/\n@Component\npublic class JwtAuthenticationEntryPoint implements AuthenticationEntryPoint, Serializable {\n\n    private static final long serialVersionUID = -1L;\n\n    @Override\n    public void commence(HttpServletRequest request, HttpServletResponse response,\n                         AuthenticationException authException) throws IOException {\n\n        response.sendError(HttpServletResponse.SC_UNAUTHORIZED, &quot;Unauthorized&quot;);\n    }\n}</code>\n        </deckgo-highlight-code>\n<p>3.8 创建<code>WebSecurityConfig</code>类， 配置 AuthenticationManager，BCryptPasswordEncoder 和验证配置。</p>\n<deckgo-highlight-code language=\"java\" terminal=\"carbon\" theme=\"one-dark\" line-numbers=\"true\"  >\n          <code slot=\"code\">package cn.funnyealge.jwt.config;\n\nimport org.springframework.beans.factory.annotation.Autowired;\nimport org.springframework.context.annotation.Bean;\nimport org.springframework.context.annotation.Configuration;\nimport org.springframework.security.authentication.AuthenticationManager;\nimport org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;\nimport org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\nimport org.springframework.security.config.annotation.web.builders.HttpSecurity;\nimport org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\nimport org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\nimport org.springframework.security.config.http.SessionCreationPolicy;\nimport org.springframework.security.core.userdetails.UserDetailsService;\nimport org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;\nimport org.springframework.security.crypto.password.PasswordEncoder;\nimport org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;\n\n/**\n * @author yangjl\n * @description\n * @date 2023-11-15 14:21\n **/\n@Configuration\n@EnableWebSecurity\n@EnableGlobalMethodSecurity(prePostEnabled = true)\npublic class WebSecurityConfig extends WebSecurityConfigurerAdapter {\n\n    @Autowired\n    private JwtAuthenticationEntryPoint jwtAuthenticationEntryPoint;\n\n    @Autowired\n    private UserDetailsService jwtUserDetailsService;\n\n    @Autowired\n    private JwtRequestFilter jwtRequestFilter;\n\n    @Autowired\n    public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {\n        auth.userDetailsService(jwtUserDetailsService).passwordEncoder(passwordEncoder());\n    }\n\n    @Bean\n    public PasswordEncoder passwordEncoder() {\n        return new BCryptPasswordEncoder();\n    }\n\n    @Bean\n    @Override\n    public AuthenticationManager authenticationManagerBean() throws Exception {\n        return super.authenticationManagerBean();\n    }\n\n    @Override\n    protected void configure(HttpSecurity httpSecurity) throws Exception {\n        httpSecurity.csrf().disable()\n                // 放行 /authenticate\n                .authorizeRequests().antMatchers(&quot;/authenticate&quot;).permitAll().\n                // 其它任何请求都需要认证\n                anyRequest().authenticated().and().\n                // 使用无状态session\n                exceptionHandling().authenticationEntryPoint(jwtAuthenticationEntryPoint).and().sessionManagement()\n                .sessionCreationPolicy(SessionCreationPolicy.STATELESS);\n\n        // 所有请求都要通过filter来验证token\n        httpSecurity.addFilterBefore(jwtRequestFilter, UsernamePasswordAuthenticationFilter.class);\n    }\n}\n</code>\n        </deckgo-highlight-code>\n<p>启动项目，使用postman请求<code>/authenticate</code>接口</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/bed327c9770c74dfc39f66e44c004863/86433/auth-api.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.5945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIBBf/EABUBAQEAAAAAAAAAAAAAAAAAAAEA/9oADAMBAAIQAxAAAAHk5YpCf//EABYQAQEBAAAAAAAAAAAAAAAAABABEf/aAAgBAQABBQI2lP/EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAEDAQE/AUf/xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAgEBPwFX/8QAFBABAAAAAAAAAAAAAAAAAAAAIP/aAAgBAQAGPwJf/8QAGRAAAgMBAAAAAAAAAAAAAAAAATEAECFR/9oACAEBAAE/Id5QAiYFEr//2gAMAwEAAgADAAAAEDv/AP/EABYRAQEBAAAAAAAAAAAAAAAAAAARUf/aAAgBAwEBPxBGP//EABYRAQEBAAAAAAAAAAAAAAAAAAARUf/aAAgBAgEBPxBWv//EABoQAQEAAgMAAAAAAAAAAAAAAAEAEBExYYH/2gAIAQEAAT8QXSeQmgHTcWAv/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"auth-api\"\n        title=\"\"\n        src=\"/static/bed327c9770c74dfc39f66e44c004863/1c72d/auth-api.jpg\"\n        srcset=\"/static/bed327c9770c74dfc39f66e44c004863/a80bd/auth-api.jpg 148w,\n/static/bed327c9770c74dfc39f66e44c004863/1c91a/auth-api.jpg 295w,\n/static/bed327c9770c74dfc39f66e44c004863/1c72d/auth-api.jpg 590w,\n/static/bed327c9770c74dfc39f66e44c004863/a8a14/auth-api.jpg 885w,\n/static/bed327c9770c74dfc39f66e44c004863/fbd2c/auth-api.jpg 1180w,\n/static/bed327c9770c74dfc39f66e44c004863/86433/auth-api.jpg 2306w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<blockquote>\n<p>TIP: 如果<code>/authenticate</code>接口抛出异常 <code>ClassNotFoundException: javax.xml.bind.DatatypeConverter</code>，将JDK版本修改为8即可。</p>\n</blockquote>\n<p>获取到token之后，在/hello请求的Header中添加 Authorization，Value的格式为 <code>Bearer TOKEN</code> Bearer后面有个空格。如图。\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d676904b4e92b5f23b99124716bcf266/6c27d/hello-api.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 44.5945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIBBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHkGFJJ/8QAFhAAAwAAAAAAAAAAAAAAAAAAEBEg/9oACAEBAAEFAg4//8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQMBAT8BR//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAECAQE/AVf/xAAUEAEAAAAAAAAAAAAAAAAAAAAg/9oACAEBAAY/Al//xAAZEAACAwEAAAAAAAAAAAAAAAAAARAhYbH/2gAIAQEAAT8h4VomQ5//2gAMAwEAAgADAAAAEOP/AP/EABYRAQEBAAAAAAAAAAAAAAAAAAARUf/aAAgBAwEBPxBGP//EABYRAQEBAAAAAAAAAAAAAAAAAAARUf/aAAgBAgEBPxBWv//EABsQAQACAgMAAAAAAAAAAAAAAAEAIRAxEYGh/9oACAEBAAE/EF0IkNKV1BuD0GbYJ//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"hello-api\"\n        title=\"\"\n        src=\"/static/d676904b4e92b5f23b99124716bcf266/1c72d/hello-api.jpg\"\n        srcset=\"/static/d676904b4e92b5f23b99124716bcf266/a80bd/hello-api.jpg 148w,\n/static/d676904b4e92b5f23b99124716bcf266/1c91a/hello-api.jpg 295w,\n/static/d676904b4e92b5f23b99124716bcf266/1c72d/hello-api.jpg 590w,\n/static/d676904b4e92b5f23b99124716bcf266/a8a14/hello-api.jpg 885w,\n/static/d676904b4e92b5f23b99124716bcf266/fbd2c/hello-api.jpg 1180w,\n/static/d676904b4e92b5f23b99124716bcf266/6c27d/hello-api.jpg 2298w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>完整项目源码：<a href=\"https://github.com/funny-eagle/jwt-example\">https://github.com/funny-eagle/jwt-example</a></p>\n<p>（完）</p>","tableOfContents":"<ul>\n<li><a href=\"#1%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAspring-boot%E9%A1%B9%E7%9B%AE%E9%85%8D%E7%BD%AEmaven%E5%9D%90%E6%A0%87%E9%9C%80%E8%A6%81%E4%BD%BF%E7%94%A8%E5%88%B0-spring-boot-starter-webspring-boot-starter-security-%E4%BB%A5%E5%8F%8A-jwt%E4%B8%BA%E4%BA%86%E7%AE%80%E5%8C%96%E4%BB%A3%E7%A0%81%E4%BD%BF%E7%94%A8%E4%BA%86lombok\">1、创建一个spring-boot项目，配置maven坐标，需要使用到 spring-boot-starter-web、spring-boot-starter-security 以及 jwt，为了简化代码，使用了lombok。</a></li>\n<li><a href=\"#2spring-boot%E5%B7%A5%E7%A8%8B%E6%90%AD%E5%BB%BA%E5%A5%BD%E4%B9%8B%E5%90%8E%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAhellocontroller%E5%86%99%E4%B8%80%E4%B8%AAget%E8%AF%B7%E6%B1%82%E7%9A%84-rest-api-hello\">2、spring-boot工程搭建好之后，创建一个HelloController，写一个GET请求的 REST API <code>/hello</code></a></li>\n<li><a href=\"#3%E6%8E%A5%E4%B8%8B%E6%9D%A5%E5%BC%80%E5%A7%8B%E9%85%8D%E7%BD%AEspring-security-%E5%92%8C-jwt\">3、接下来开始配置spring security 和 JWT。</a></li>\n</ul>","frontmatter":{"title":"【JWT】基于SpringBoot的JSON Web Token使用示例","tags":["coding"],"description":"使用spring-boot, spring security, jjtw 搭建的JWT示例项目","date":"2023-11-16"}}},"pageContext":{"slug":"/jwt-example/","previous":{"fields":{"slug":"/Introduction-to-jwt/"},"frontmatter":{"title":"【JWT】JSON Web Token 入门简介","tags":["coding"],"slug":""}},"next":null}},"staticQueryHashes":["2052298874"],"slicesMap":{}}